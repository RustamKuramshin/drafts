version: 1

defaults:
  gitlab:
    base_url: "https://gitlab.platform.corp"
    token_env: GITLAB_TOKEN
    insecure: true

  jira:
    base_url: "https://track.magnit.ru"
    token_env: JIRA_TOKEN
    user_env: JIRA_USER
    key_re: "[A-Z][A-Z0-9]+-[0-9]+"
    project: "MMBT"
    insecure: true
    user_agent: "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.0.0 Safari/537.36"

  commit_filter:
    ignore_patterns:
      - "^Merge branch"
      - "^Merge remote-tracking branch"
      - "^Merge pull request"
      - "^Merge .* into "
      - "^Revert "
      - "^WIP"
      - "^\\[skip ci\\]"
      - "^\\[ci skip\\]"

projects:
  - id: "mm-core-bff"
    name: "mm-core-bff"
    repo_url: "https://gitlab.platform.corp/magnitonline/mm/backend/mm-core-bff"
    deploy:
      order: 10

    targets:
      stage:
        from: "development"
        to: "stage"
      prod:
        from: "stage"
        to: "master"

  - id: "hive-graphql-gateway"
    name: "hive-graphql-gateway"
    repo_url: "https://gitlab.platform.corp/magnitonline/mm/backend/hive-graphql-gateway"
    deploy:
      order: 20

    targets:
      stage:
        from: "development"
        to: "staging"
      prod:
        from: "staging"
        to: "master"

  - id: "api-graphql"
    name: "api-graphql"
    repo_url: "https://gitlab.platform.corp/magnitonline/mm/backend/api-graphql"
    deploy:
      order: 30

    targets:
      stage:
        from: "development"
        to: "stage"
      prod:
        from: "stage"
        to: "master"

  - id: "api-payment-service"
    name: "api-payment-service"
    repo_url: "https://gitlab.platform.corp/magnitonline/mm/backend/api-payment-service"
    deploy:
      order: 40

    targets:
      stage:
        from: "development"
        to: "stage"
      prod:
        from: "stage"
        to: "master"

  - id: "mm-geo-service"
    name: "mm-geo-service"
    repo_url: "https://gitlab.platform.corp/magnitonline/mm/backend/mm-geo-service"
    deploy:
      order: 50

    targets:
      stage:
        from: "development"
        to: "stage"
      prod:
        from: "stage"
        to: "master"

  - id: "api-cart-service"
    name: "api-cart-service"
    repo_url: "https://gitlab.platform.corp/magnitonline/mm/backend/api-cart-service"
    deploy:
      order: 60

    targets:
      stage:
        from: "development"
        to: "stage"
      prod:
        from: "stage"
        to: "master"

  - id: "api-cart-composer"
    name: "api-cart-composer"
    repo_url: "https://gitlab.platform.corp/magnitonline/mm/backend/api-cart-composer"
    deploy:
      order: 70

    targets:
      stage:
        from: "development"
        to: "stage"
      prod:
        from: "stage"
        to: "master"

  - id: "ke-notification-service"
    name: "ke-notification-service"
    repo_url: "https://gitlab.platform.corp/magnitonline/mm/backend/ke-notification-service"
    deploy:
      order: 80

    targets:
      stage:
        from: "development"
        to: "stage"
      prod:
        from: "stage"
        to: "master"

  - id: "notifications-proxy-service"
    name: "notifications-proxy-service"
    repo_url: "https://gitlab.platform.corp/magnitonline/mm/backend/notifications-proxy-service"
    deploy:
      order: 90

    targets:
      stage:
        from: "development"
        to: "stage"
      prod:
        from: "stage"
        to: "master"

  - id: "api-finance-service"
    name: "api-finance-service"
    repo_url: "https://gitlab.platform.corp/magnitonline/mm/backend/api-finance-service"
    deploy:
      order: 100

    targets:
      stage:
        from: "development"
        to: "stage"
      prod:
        from: "stage"
        to: "master"

  - id: "popup-service"
    name: "popup-service"
    repo_url: "https://gitlab.platform.corp/magnitonline/mm/backend/popup-service"
    deploy:
      order: 110

    targets:
      stage:
        from: "development"
        to: "stage"
      prod:
        from: "stage"
        to: "master"

  - id: "analytics-events-feeder"
    name: "analytics-events-feeder"
    repo_url: "https://gitlab.platform.corp/magnitonline/mm/backend/analytics-events-feeder"
    deploy:
      order: 120

    targets:
      prod:
        from: "development"
        to: "master"

  - id: "analytic-back-events-holder"
    name: "analytic-back-events-holder"
    repo_url: "https://gitlab.platform.corp/magnitonline/mm/backend/analytic-back-events-holder"
    deploy:
      order: 130

    targets:
      prod:
        from: "development"
        to: "main"